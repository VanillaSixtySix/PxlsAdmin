var modal_footer = '<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>' +
    '<button id="rmd-unclaim" type="button" class="btn btn-primary">Unclaim</button>' +
    '<button id="rmd-claim" type="button" class="btn btn-warning">Claim</button>' +
    '<button id="rmd-resolve" type="button" class="btn btn-success">Resolve</button>';


$('#report_info').on('show.bs.modal', function (event) {
    var button = $(event.relatedTarget);
    var modal = $(this);
    modal.find('#modal-footer').html(modal_footer);
    $.getJSON('{{ webroots.panel }}/api/report/details/'+button.data('reportid'),function(data){
        if (window.__dynVars && window.__dynVars.viewOnly === true) {
            modal.find('#rmd-claim,#rmd-unclaim,#rmd-resolve').hide();
        }
        var server = data.reporter.username === null;
        // general
        modal.find('#rmd-g-id').text(data.general.id.toString() + (server ? ' SERVER REPORT' : ''));
        modal.find('#rmd-g-position').html(server ? 'N/A' : data.general.position);
        modal.find('#rmd-g-message').html(data.general.message);
        modal.find('#rmd-g-time').text(data.general.time);
        modal.find('#rmd-g-claimed').text(data.general.claimed);

        //reporter
        if (server) {
            modal.find('#rmd-a-username').closest('.col-md-4').hide();
        } else {
            modal.find('#rmd-a-username').closest('.col-md-4').show();
            modal.find('#rmd-a-username').html(`<a href="${'{{ path_for('profileId', {'id': '{id}'}) }}'.replace('{id}', data.reporter.id)}" target="_blank">${data.reporter.username}</a>`);
            modal.find('#rmd-a-last-ip').html(`<a href="{{ path_for('search') }}?q=${data.reporter.ip.last}&type=ip">${data.reporter.ip.last}</a>`);
            modal.find('#rmd-a-login-ip').html(`<a href="{{ path_for('search') }}?q=${data.reporter.ip.signup}&type=ip">${data.reporter.ip.signup}</a>`);
            modal.find('#rmd-a-logins').text(data.reporter.logins.map(({ service, service_uid }) => `${service}:${service_uid}`).join(', '));
            modal.find('#rmd-a-signup').text(data.reporter.signup);
            modal.find('#rmd-a-role').text(data.reporter.role);
            modal.find('#rmd-a-pixel').text(data.reporter.pixelcount);
            if (data.reporter.ban.expiry == null) {
                modal.find('#rmd-a-ban').html('None')
            } else {
                modal.find('#rmd-a-ban').html(data.reporter.ban.expiry + " (" + data.reporter.ban.reason + ")");
            }
        }

        //reported
        if (data.reported.username == null) {
            // This relies on the username existing
            modal.find('#rmd-b-username').closest('.col-md-4').html('<b>Reported data unavailable</b>');
        } else {
            modal.find('#rmd-b-username').html(`<a href="${'{{ path_for('profileId', {'id': '{id}'}) }}'.replace('{id}', data.reported.id)}" target="_blank">${data.reported.username}</a>`);
            modal.find('#rmd-b-logins').text(data.reported.logins.map(({ service, service_uid }) => `${service}:${service_uid}`).join(', '));
            modal.find('#rmd-b-last-ip').html(`<a href="{{ path_for('search') }}?q=${data.reported.ip.last}&type=ip">${data.reported.ip.last}</a>`);
            modal.find('#rmd-b-login-ip').html(`<a href="{{ path_for('search') }}?q=${data.reported.ip.signup}&type=ip">${data.reported.ip.signup}</a>`);
            modal.find('#rmd-b-signup').text(data.reported.signup);
            modal.find('#rmd-b-roles').text(data.reported.roles);
            modal.find('#rmd-b-pixel').text(data.reported.pixelcount);
            if (data.reported.ban.expiry == null) {
                modal.find('#rmd-b-ban').html('None')
            } else {
                modal.find('#rmd-b-ban').html(data.reported.ban.expiry + " (" + data.reported.ban.reason + ")");
            }
        }

        let cannotOverwrite = !['moderator', 'administrator', 'developer'].some(r => data.self.roles.includes(r)) && !data.general.claimed_by_you;
        modal.find('#rmd-claim').data('reportid',data.general.id);
        modal.find('#rmd-unclaim').data('reportid',data.general.id)[0].disabled=cannotOverwrite;
        modal.find('#rmd-resolve').data('reportid',data.general.id)[0].disabled=cannotOverwrite;

        modal.find('#rmd-claim').click(function(){
            $.ajax({
                url: "{{ webroots.panel }}/api/report/claim/" + $(this).data('reportid')
            }).done(function() {
                modal.find('#rmd-claim').hide();
                modal.find('#rmd-unclaim').show();
                modal.find('#rmd-resolve').show();
                setTimeout(function(){reloadReports();}, 500);
            });
        });
        modal.find('#rmd-unclaim').click(function(){
            var lmao = $("#modal-footer").clone();
            $.ajax({
                url: "{{ webroots.panel }}/api/report/unclaim/" + $(this).data('reportid')
            }).done(function() {
                modal.find('#rmd-claim').show();
                modal.find('#rmd-unclaim').hide();
                modal.find('#rmd-resolve').hide();
                setTimeout(function(){reloadReports();}, 500);
            });
        });
        modal.find('#rmd-resolve').click(function(){
            var lmao = $("#modal-footer").clone();
            $.ajax({
                url: "{{ webroots.panel }}/api/report/resolve/" + $(this).data('reportid')
            }).done(function() {
                setTimeout(function(){modal.modal("hide");reloadReports();}, 500);
            });
        });

        if(data.general.claimed == "no one") {
            modal.find('#rmd-unclaim').hide();
            modal.find('#rmd-resolve').hide();
        } else if(data.general.claimed == "{{ userdata.username }}") {
            modal.find('#rmd-claim').hide();
        } else {
            modal.find('#rmd-claim').hide();
            modal.find('#rmd-unclaim').hide();
            modal.find('#rmd-resolve').hide();
        }
    });
});
